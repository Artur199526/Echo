<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Pro ‚Äî Ultimate Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { background: #020617; color: #f8fafc; font-family: sans-serif; margin: 0; padding: 15px; }
        .echo-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 20px; overflow: hidden; margin-bottom: 20px; }
        #map { height: 250px; width: 100%; border-radius: 20px; background: #1e293b; border: 2px solid #312e81; }
        .input-field { background: #1e293b; border: 1px solid #334155; border-radius: 12px; color: white; padding: 12px; width: 100%; margin-bottom: 8px; outline: none; }
        #previewContainer { width: 100%; display: none; margin-bottom: 15px; }
        #preview { width: 100%; height: 200px; object-fit: cover; border-radius: 15px; border: 2px solid #6366f1; }
        .btn-send { background: #6366f1; width: 100%; padding: 16px; border-radius: 15px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

    <h1 class="text-2xl font-black text-indigo-500 mb-4 italic">ECHO PRO 2.0</h1>

    <div id="map"></div>
    <div id="debug-info" class="text-[10px] text-red-500 mb-2"></div>

    <div class="echo-card p-4">
        <div id="previewContainer">
            <img id="preview" src="">
        </div>
        
        <input type="text" id="itemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="input-field">
        <textarea id="itemDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." class="input-field h-20"></textarea>

        <div class="grid grid-cols-2 gap-2 mb-4">
            <input type="text" id="tgNick" placeholder="Telegram @nick" class="input-field mb-0">
            <input type="text" id="waNum" placeholder="WhatsApp (79...)" class="input-field mb-0">
        </div>

        <div class="flex gap-2 mb-4">
            <button onclick="document.getElementById('fileInput').click()" class="flex-1 bg-slate-800 p-3 rounded-xl text-[10px] font-bold uppercase border border-indigo-500/30">
                üì∏ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
            </button>
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImage(this)">
            
            <div class="flex items-center px-3 bg-slate-800 rounded-xl border border-amber-500/30">
                <input type="checkbox" id="boostCheck" class="w-4 h-4 mr-2">
                <span class="text-[9px] font-bold text-amber-500">BOOST</span>
            </div>
        </div>

        <button onclick="sendSignal()" class="btn-send active:scale-95 transition-all">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≠—Ö–æ</button>
    </div>

    <div id="feed" class="space-y-6 pb-10"></div>

    <script>
        let map, currentImg = "";
        const debug = document.getElementById('debug-info');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å –∑–∞—â–∏—Ç–æ–π
        try {
            map = L.map('map', { zoomControl: false }).setView([55.75, 37.61], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            setTimeout(() => { map.invalidateSize(); }, 500); // –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Ä—ã–π —ç–∫—Ä–∞–Ω –∫–∞—Ä—Ç—ã

            map.locate({setView: true, maxZoom: 14});
            map.on('locationerror', () => debug.innerText += " GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. ");
        } catch (e) {
            debug.innerText += "–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã: " + e.message;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
        function handleImage(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('preview');
                    const container = document.getElementById('previewContainer');
                    preview.src = e.target.result;
                    container.style.display = 'block';
currentImg = e.target.result;
                    console.log("–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ");
                };
                reader.onerror = () => debug.innerText += " –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. ";
                reader.readAsDataURL(file);
            }
        }

        function sendSignal() {
            const name = document.getElementById('itemName').value;
            if (!name || !currentImg) return alert("–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ!");

            const center = map.getCenter();
            const signal = {
                lat: center.lat, lng: center.lng,
                name: name,
                desc: document.getElementById('itemDesc').value,
                tg: document.getElementById('tgNick').value,
                wa: document.getElementById('waNum').value,
                isBoosted: document.getElementById('boostCheck').checked,
                img: currentImg,
                id: Date.now()
            };

            const saved = JSON.parse(localStorage.getItem('echo_v5')) || [];
            saved.unshift(signal);
            localStorage.setItem('echo_v5', JSON.stringify(saved));
            location.reload();
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–µ–Ω—Ç—ã
        (function loadSignals() {
            const feed = document.getElementById('feed');
            const saved = JSON.parse(localStorage.getItem('echo_v5')) || [];
            
            saved.forEach(s => {
                L.marker([s.lat, s.lng]).addTo(map).bindPopup(s.name);
                
                const card = document.createElement('div');
                card.className = echo-card ${s.isBoosted ? 'border-2 border-amber-500' : ''};
                card.innerHTML = `
                    <img src="${s.img}" style="width:100%; height:180px; object-fit:cover;">
                    <div class="p-4">
                        <h3 class="font-bold ${s.isBoosted ? 'text-amber-500' : ''}">${s.name}</h3>
                        <p class="text-xs text-slate-400 mt-1">${s.desc}</p>
                    </div>
                `;
                feed.appendChild(card);
            });
        })();
    </script>
</body>
</html>
